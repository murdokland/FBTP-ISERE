<!DOCTYPE html> 
<html>
<head>
<meta charset="utf-8">
<title>BTP38</title>
<link href="jquery-mobile/jquery.mobile-1.3.1.min.css" rel="stylesheet" type="text/css"/>
<link href="css/style.css" rel="stylesheet" type="text/css"/>
<script src="jquery-mobile/jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="jquery-mobile/jquery.mobile-1.3.1.min.js" type="text/javascript"></script>
<script src="phonegap.js"></script>

<script>
function verif(data) {
	data= data.replace(/''/g,"'");
	return data;
}
function getParamValue(param,url)
{
	var u = url == undefined ? document.location.href : url;
	var reg = new RegExp('(\\?|&|^)'+param+'=(.*?)(&|$)');
	matches = u.match(reg);
	return matches[2] != undefined ? decodeURIComponent(matches[2]).replace(/\+/g,' ') : '';
}
function stripslashes(str) {
    str = str.replace(/\\'/g, '\'');
    str = str.replace(/\\\\/g, '\\');
    return str;
}
/*function getlenomdelacat(param,url)
{
	var u = url == undefined ? document.location.href : url;
	var reg = new RegExp('(\\?|&|^)'+param+'=(.*?)(&|$)');
	matches = u.match(reg);
	matches[2] != undefined ? decodeURIComponent(matches[2]).replace(/\+/g,' ') : '';
	var lacat;
	if ((matches[2]) == 01) { 
		lacat = "CANALISATIONS";
		return lacat ;
	}
	if ((matches[2]) == 02) { 
		lacat = "CARRELAGES, MOSAIQUES, REVETEMENTS";
		return lacat ;
	}
	if ((matches[2]) == 03) { 
		lacat = "CHARPENTE, MENUISERIE ET PARQUETS";
		return lacat ;
	}	
	if ((matches[2]) == 04) { 
		lacat = "CLIMATIQUE";
		return lacat ;
	}
	if ((matches[2]) == 05) { 
		lacat = "CONSTRUCTION IMMOBILIERE";
		return lacat ;
	}
	if ((matches[2]) == 06) { 
		lacat = "COUVERT., PLOMB. ZING. &  INST. SANIT.";
		return lacat ;
	}
	if ((matches[2]) == 07) { 
		lacat = "DECONSTRUCTION";
		return lacat ;
	}
	if ((matches[2]) == 08) { 
		lacat = "EQUIPEMENT ELECTRIQUE";
		return lacat ;
	}
	if ((matches[2]) == 09) { 
		lacat = "ETANCHEITE";
		return lacat ;
	}	
	if ((matches[2]) == 10) { 
		lacat = "INDUSTRIE ROUTIERE";
		return lacat ;
	}
	if ((matches[2]) == 11) { 
		lacat = "ISOLATION";
		return lacat ;
	}
	if ((matches[2]) == 12) { 
		lacat = "MACONNERIE BETON ARME";
		return lacat ;
	}
	if ((matches[2]) == 13) { 
		lacat = "MACONNERIE RENOVATION";
		return lacat ;
	}	
	if ((matches[2]) == 14) { 
		lacat = "MAINTENANCE MULTI TECHNIQUES";
		return lacat ;
	}
	if ((matches[2]) == 15) { 
		lacat = "METALLERIE";
		return lacat ;
	}	
	if ((matches[2]) == 16) { 
		lacat = "PEINTRES, PLÂTRIERS, FACAD. ,STAFF.";
		return lacat ;
	}
	if ((matches[2]) == 17) { 
		lacat = "RAMONAGE FUMISTERIE";
		return lacat ;
	}
	if ((matches[2]) == 18) { 
		lacat = "RECYCLAGE";
		return lacat ;
	}
	if ((matches[2]) == 19) { 
		lacat = "RESEAUX SECS ET D";
		return lacat ;
	}	
	if ((matches[2]) == 20) { 
		lacat = "TAILLE DE PIERRE, MARBRERIE";
		return lacat ;
	}
	if ((matches[2]) == 21) { 
		lacat = "TERRASSEMENTS GENIE CIVIL ET OUVRAGES";
		return lacat ;
	}	
	if ((matches[2]) == 22) { 
		lacat = "TOITURE";
		return lacat ;
	}
	if ((matches[2]) == 23) { 
		lacat = "TRAVAUX SOUTERRAINS";
		return lacat ;
	}
	if ((matches[2]) == 24) { 
		lacat = "VITRERIE MIROITERIE";
		return lacat ;
	}
	if ((matches[2]) == 25) { 
		lacat = "VOIRIE URBAINE ET DEPARTEMENTALE";
		return lacat ;
	}		
}*/
/*function getlenumerodelacat(nomdelacat)
{
	
	var nomdelacat;
	
	if (nomdelacat == "CANALISATIONS") { 
		numdelacat = 01;
		return numdelacat ;
	}
	if (nomdelacat == "CARRELAGES, MOSAIQUES, REVETEMENTS" ) { 
		numdelacat = 02;
		return numdelacat ;
	}
	if (nomdelacat ==  "CHARPENTE, MENUISERIE ET PARQUETS") { 
		numdelacat = 03;
		return numdelacat ;
	}	
	if (nomdelacat == "CLIMATIQUE" ) { 
		numdelacat = 04;
		return numdelacat ;
	}
	if (nomdelacat == "CONSTRUCTION IMMOBILIERE") { 
		numdelacat = 05;
		return numdelacat ;
	}
	if (nomdelacat == "COUVERT., PLOMB. ZING. &  INST. SANIT.") { 
		numdelacat = 06;
		return numdelacat ;
	}
	if (nomdelacat == "DECONSTRUCTION") { 
		numdelacat = 07;
		return numdelacat ;
	}
	if (nomdelacat == "EQUIPEMENT ELECTRIQUE") { 
		numdelacat = 08;
		return numdelacat ;
	}
	if (nomdelacat == "ETANCHEITE") { 
		numdelacat = 09;
		return numdelacat ;
	}	
	if (nomdelacat == "INDUSTRIE ROUTIERE") { 
		numdelacat = 10;
		return numdelacat ;
	}
	if (nomdelacat == "ISOLATION") { 
		numdelacat = 11;
		return numdelacat ;
	}
	if (nomdelacat == "MACONNERIE BETON ARME" ) { 
		numdelacat = 12;
		return numdelacat ;
	}
	if (nomdelacat == "MACONNERIE RENOVATION") { 
		numdelacat = 13;
		return numdelacat ;
	}	
	if (nomdelacat == "MAINTENANCE MULTI TECHNIQUES") { 
		numdelacat = 14;
		return numdelacat ;
	}
	if (nomdelacat == "METALLERIE") { 
		numdelacat = 15;
		return numdelacat ;
	}	
	if (nomdelacat == "PEINTRES, PLÂTRIERS, FACAD. ,STAFF." ) { 
		numdelacat = 16;
		return numdelacat ;
	}
	if (nomdelacat == "RAMONAGE FUMISTERIE") { 
		numdelacat = 17;
		return numdelacat ;
	}
	if (nomdelacat == "RECYCLAGE") { 
		numdelacat = 18;
		return numdelacat ;
	}
	if (nomdelacat == "RESEAUX SECS ET D'ECLAIRAGE") { 
		numdelacat = 19;
		return numdelacat ;
	}	
	if (nomdelacat == "TAILLE DE PIERRE, MARBRERIE") { 
		numdelacat = 20;
		return numdelacat ;
	}
	if (nomdelacat == "TERRASSEMENTS GENIE CIVIL ET OUVRAGES") { 
		numdelacat = 21;
		return numdelacat ;
	}	
	if (nomdelacat == "TOITURE") { 
		numdelacat = 22;
		return numdelacat ;
	}
	if (nomdelacat == "TRAVAUX SOUTERRAINS") { 
		numdelacat = 23;
		return numdelacat ;
	}
	if (nomdelacat == "VITRERIE MIROITERIE") { 
		numdelacat = 24;
		return numdelacat ;
	}
	if (nomdelacat == "VOIRIE URBAINE ET DEPARTEMENTALE") { 
		numdelacat = 25;
		return numdelacat ;
	}		
}*/
</script>
<script>	
$(document).ready(function(){
	/*var backButton = $('a[data-theme="app-ios"]').filter('[data-rel="back"]');
    backButton.find('.ui-icon').remove();
    backButton.append('<div class="ios-tip"><span>&nbsp;</span></div>');*/
	
	var nom = getParamValue('nom');
	var ville = getParamValue('ville');
	var cp = getParamValue('cp');
	var lenomdelacat = getParamValue('cat');
	
	//var numerocat = getlenumerodelacat(lenomdelacat);;
	//var cat = getParamValue('id');
	
	//var output = $('#output_fiche');
	//output.append('Chargement');
	
	var output = $("#successfullStatements");
	
	var successfullStatements = $("#successfullStatements"),
		errors = $("#errors");
	
	successfullStatements.append('<br><p align="center">chargement</p>');	 	
	
	var url =  'http://btp-appli.com/btp38/recherche.php?nom='+nom+'&ville='+ville+'&cp='+cp+'&lenomdelacat='+lenomdelacat;
	console.log(url);
	
	
	$.ajax({
		url: 'http://btp-appli.com/btp38/recherche.php?nom='+nom+'&ville='+ville+'&cp='+cp+'&lenomdelacat='+lenomdelacat,
		dataType: 'jsonp',
		jsonp: 'jsoncallback',
		timeout: 5000,
		success: function(data, status){
			output.empty();
			if (data.length == 0) {
				output.append("<p style='text-align:center; font-size:18px; margin-top:20px;'>Pas de résultat</p>");
				output.listview("refresh");
			}
			$.each(data, function(i,item){
				
				var donnee =  '<li><a href="fiche.html?identifiant='+item.id+'&cat='+item.SECTIONPROFESSIONNELLE+'" rel="external" data-transition="slide" data-icon="arrow-r" data-iconpos="right" >'+stripslashes(item.RAISONSOCIALE)+'<p class="subItem"><span style="color:#000; font-size:9px;" >'+stripslashes(item.VILLE)+'</span></p></a></li>';
				output.append(donnee);
				output.listview("refresh");
			});
		},
		error: function(request, error){
			
			output.text('Problème avec les données.');
			//output.append('Problème avec les données.');
			//output.text(request.responseText);
			//errors.append("<li>"+error.message+" Problème avec les données: "+statement+"</li>");
		}
	}); 
	 
	 
	if (nom == 0 && ville==0 && cp==0 && cat==0) {
		successfullStatements.empty();
		successfullStatements.append('<br><p align="center">Merci de saisir au moins un champ</p>');	
	};
	
});
</script>
</head> 
<body> 
<div data-role="page" id="page">
    <div data-role="header" data-id="head1" data-position="fixed" data-theme="c">
            <h3>Résultats</h3>
           <a href="#" data-role="button" data-rel="back" data-icon="arrow-l" data-theme="b" >Recherche</a>
        </div>
	<div data-role="content">	
		<div id="output">
        <ul id="successfullStatements" data-role="listview"></ul>
		<ul id="errors"></ul>
        </div>        
	</div>
</div>

</body>
</html>